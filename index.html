<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>NetGuet</title>
    <style>
        :root { --bg: #36393f; --side: #2f3136; --dark: #202225; --accent: #5865f2; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
        
        /* AUTH */
        #auth-screen { position: fixed; inset: 0; background: #5865f2; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .auth-card { background: var(--bg); padding: 30px; border-radius: 8px; width: 350px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        /* APP */
        #app { display: none; width: 100%; height: 100%; flex-direction: row; }
        .sidebar { width: 240px; background: var(--side); padding: 20px; font-weight: bold; }
        .chat { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; }
        
        input { background: #40444b; border: none; color: white; padding: 12px; border-radius: 5px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
        .link { color: #00aff4; cursor: pointer; text-align: center; display: block; margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h2 id="auth-title" style="text-align: center;">Se connecter</h2>
        <div id="pseudo-field" style="display: none;">
            <input type="text" id="pseudo" placeholder="PSEUDO">
        </div>
        <input type="email" id="email" placeholder="E-MAIL">
        <input type="password" id="mdp" placeholder="MOT DE PASSE">
        <button id="auth-btn" onclick="validerAuth()">Connexion</button>
        <span class="link" id="toggle-link" onclick="toggle()">Créer un compte ?</span>
    </div>
</div>

<div id="app">
    <div class="sidebar">NetGuet<br><br><span style="color:#8e9297"># général</span></div>
    <div class="chat">
        <div id="messages"></div>
        <div style="padding: 20px;"><input type="text" id="msg-input" placeholder="Envoyer un message..." onkeypress="if(event.key==='Enter') envoyer()"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let isLogin = true;
    let monPseudo = localStorage.getItem('net_p');

    if(monPseudo) { startApp(); }

    function toggle() {
        isLogin = !isLogin;
        document.getElementById('auth-title').innerText = isLogin ? "Se connecter" : "Créer un compte";
        document.getElementById('auth-btn').innerText = isLogin ? "Connexion" : "Inscription";
        document.getElementById('pseudo-field').style.display = isLogin ? "none" : "block";
        document.getElementById('toggle-link').innerText = isLogin ? "Créer un compte ?" : "Déjà un compte ?";
    }

    async function validerAuth() {
        const email = document.getElementById('email').value;
        const mdp = document.getElementById('mdp').value;
        const pseudo = document.getElementById('pseudo').value;
        
        const res = await fetch('/auth', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, mdp, pseudo, type: isLogin ? 'login' : 'register' })
        });
        
        const data = await res.json();
        if(data.success) {
            localStorage.setItem('net_p', data.pseudo);
            location.reload();
        } else { alert(data.error); }
    }

    function startApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
    }

    function envoyer() {
        const inp = document.getElementById('msg-input');
        if(inp.value) {
            socket.emit('chat_message', {user: monPseudo, text: inp.value});
            inp.value = '';
        }
    }

    socket.on('chat_message', (d) => {
        const div = document.createElement('div');
        div.innerHTML = `<p><b style="color:#5865f2">${d.user}</b>: ${d.text}</p>`;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });

    socket.on('load_history', (msgs) => {
        msgs.forEach(m => {
            const div = document.createElement('div');
            div.innerHTML = `<p><b style="color:#5865f2">${m.user}</b>: ${m.text}</p>`;
            document.getElementById('messages').appendChild(div);
        });
    });
</script>
</body>
</html>
